<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../Insight_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="Data_Collection_for_Red_Hat_Enterprise_Linux_OpenStack_Platform" remap="TID_25811">
	<title>Data Collection for Red Hat Enterprise Linux OpenStack Platform</title>
	<para>
		Before you can collect data from a Red Hat Enterprise Linux OpenStack Platform (RHELOSP) provider, you must install Ceilometer and configure it to accept queries from external systems.
	</para>
	<para>
		These instructions require a Red Hat Enterprise Linux 6.4 @base installation of RHELOSP and registration to a satellite that has access to both the RHELOSP and RHEL Server Optional channels.
	</para>
	<procedure>
		<title>To Install and Configure Ceilometer for Data Collection</title>
		<note>
			<para>
				Perform all steps on your RHELOSP system.
			</para>
		</note>
		<step>
			<para>
				Add the required channels and update your system: 
				<screen># rhn-channel --add -c rhel-x86_64-server-6-ost-3 -c rhel-x86_64-server-optional-6
# yum update -y
# reboot</screen>
			</para>
		</step>
		<step>
			<para>
				Install Ceilometer: 
				<screen># yum install *ceilometer*</screen>
			</para>
		</step>
		<step>
			<para>
				Install and start the MongoDB store: 
				<screen># yum install mongodb-server
# sed -i '/--smallfiles/!s/OPTIONS=\"/OPTIONS=\"--smallfiles /' /etc/sysconfig/mongod
# service mongod start</screen>
			</para>
		</step>
		<step>
			<para>
				Create the following users and roles: 
				<screen># SERVICE_TENANT=$(keystone tenant-list | grep services | awk '{print $2}')
# ADMIN_ROLE=$(keystone role-list | grep ' admin ' | awk '{print $2}')
# SERVICE_PASSWORD=servicepass
# CEILOMETER_USER=$(keystone user-create --name=ceilometer \
--pass="$SERVICE_PASSWORD" \
--tenant_id $SERVICE_TENANT \
--email=ceilometer@example.com | awk '/ id / {print $4}')
# RESELLER_ROLE=$(keystone role-create --name=ResellerAdmin | awk '/ id / {print $4}')
# ADMIN_ROLE=$(keystone role-list | awk '/ admin / {print $2}')
# for role in $RESELLER_ROLE $ADMIN_ROLE ; do
keystone user-role-add --tenant_id $SERVICE_TENANT \
--user_id $CEILOMETER_USER --role_id $role
done</screen>
			</para>
		</step>
		<step>
			<para>
				Configure the authtoken in <filename>ceilometer.conf</filename>: 
				<screen># openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken auth_host 127.0.0.1
# openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken auth_port 35357
# openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken auth_protocol http
# openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken admin_tenant_name services
# openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken admin_user ceilometer
# openstack-config --set /etc/ceilometer/ceilometer.conf keystone_authtoken admin_password $SERVICE_PASSWORD</screen>
			</para>
		</step>
		<step>
			<para>
				Configure the user credentials in <filename>ceilometer.conf</filename>: 
				<screen># openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT os_auth_url http://127.0.0.1:35357/v2.0
# openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT os_tenant_name services
# openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT os_password $SERVICE_PASSWORD
# openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT os_username ceilometer</screen>
			</para>
		</step>
		<step>
			<para>
				Start the Ceilometer services: 
				<screen># for svc in compute central collector api ; do
service openstack-ceilometer-$svc start
done</screen>
			</para>
		</step>
		<step>
			<para>
				Register an endpoint with the service catalog. Replace <replaceable>$EXTERNALIFACE</replaceable> with the IP address of your external interface: 
				<screen># keystone service-create --name=ceilometer \
--type=metering --description="Ceilometer Service"
# CEILOMETER_SERVICE=$(keystone service-list | awk '/ceilometer/ {print $2}')
# keystone endpoint-create \
--region RegionOne \
--service_id $CEILOMETER_SERVICE \
--publicurl "http://$EXTERNALIFACE:8777/" \
--adminurl "http://$EXTERNALIFACE:8777/" \
--internalurl "http://localhost:8777/"</screen>
			</para>
		</step>
		<step>
			<para>
				Enable access to Ceilometer from external systems: 
				<screen># iptables -I INPUT -p tcp -m multiport --dports 8777 -m comment --comment "001 ceilometer incoming" -j ACCEPT
# iptables save</screen>
			</para>
		</step>
		<step>
			<para>
				Confirm the status of OpenStack and the Ceilometer services: 
				<screen># openstack-status
# for svc in compute central collector api ; do
service openstack-ceilometer-$svc status
done</screen>
			</para>
		</step>
		<step>
			<para>
				Verify Ceilometer is working correctly by authenticating as a user with instances running, for example <literal>admin</literal>. Pipe the sample for the cpu meter to count lines and confirm that the value changes according to the interval specified in <filename>/etc/ceilometer/pipeline.yaml</filename>. The default interval is 600 seconds.
			</para>
			<screen># . ~/keystonerc_admin
# ceilometer sample-list -m cpu |wc -l</screen>
		</step>
		<step>
			<para>
				Add the configured OpenStack provider to CloudForms Management Engine. After adding the provider, capacity and utilization data for your instances populate in a few minutes.
			</para>
		</step>
	</procedure>
</section>
