<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Security_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="chap-Red_Hat_CloudForms-Security_Guide-Setting_the_Password_for_the_Appliance_Database" lang="en-US">
  <title>Restricting Hosts Access to the Appliance Database</title>
  <para>
    Strengthening the host-based authentication (HBA) settings on an appliance database helps with preventing unauthorized access from external hosts. The HBA settings restrict access to an IP address range so that only hosts within that range have access.
  </para>
  <para>
    Restricting access to the database requires modifications to the <filename>/opt/rh/postgresql92/root/var/lib/pgsql/data/pg_hba.conf</filename> file. This file contains a text-based table with some initial settings:
  </para>
  <screen>
# TYPE    DATABASE USER  ADDRESS       METHOD
local     all      all                 peer map=usermap
host      all      all   all           md5
#hostssl  all      all   all           md5
  </screen>
  <para>
    This format for this table uses the following header columns:
  </para>
  <variablelist>
    <varlistentry>
      <term>TYPE</term>
      <listitem><para>This defines the access type, either local access from the database host (<literal>local</literal>), remote access from an external host regardless of encryption (<literal>host</literal>), external access with encryption (<literal>hostssl</literal>), or external access without encryption (<literal>nohostssl</literal>).</para></listitem>
    </varlistentry>
    <varlistentry>
      <term>DATABASE</term>
      <listitem><para>The name of the database the host can access. Use <literal>all</literal> for all databases.</para></listitem>
    </varlistentry>
    <varlistentry>
      <term>USER</term>
      <listitem><para>The name of the user the host can use to access the database. Use <literal>all</literal> for all users.</para></listitem>
    </varlistentry>
    <varlistentry>
      <term>ADDRESS</term>
      <listitem>
        <para>
          The IP address of the host or address range of hosts with access to the database. This can either be:
        </para>
        <itemizedlist>
          <listitem>
            <para>
              A single address:
            </para>
            <screen>
host    all      all   192.168.1.10           md5
            </screen>
          </listitem>
          <listitem>
            <para>
              An address range using a CIDR mask:
            </para>
            <screen>
host    all      all   192.168.1.0/24           md5
            </screen>
          </listitem>
          <listitem>
            <para>
              An address range using a seperate subnet mask value
            </para>
            <screen>
host    all      all   192.168.1.0  255.255.255.0            md5
            </screen>
          </listitem>
        </itemizedlist>
        <note>
          <para>
            <literal>ADDRESS</literal> is not required for <literal>local</literal> connections.
          </para>
        </note>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>METHOD</term>
      <listitem>
        <para>The authentication method, which includes:</para>
        <itemizedlist>
          <listitem>
            <para><literal>trust</literal> - Allow the connection unconditionally. This method allows anyone that can connect to the PostgreSQL database server to login as any PostgreSQL user they wish, without the need for a password or any other authentication. </para>
          </listitem>
          <listitem>
            <para><literal>reject</literal> - Reject the connection unconditionally. This is useful for "filtering out" certain hosts from a group, for example a reject line could block a specific host from connecting, while a later line allows the remaining hosts in a specific network to connect.</para>
          </listitem>
          <listitem>
            <para><literal>md5</literal> - Require the client to supply an MD5-encrypted password for authentication.</para>
          </listitem>
          <listitem>
            <para><literal>password</literal> - Require the client to supply an unencrypted password for authentication. Since the password is sent in clear text over the network, this should not be used on untrusted networks.</para>
          </listitem>
          <listitem>
            <para><literal>ident</literal> - Obtain the operating system user name of the client by contacting the ident server on the client and check if it matches the requested database user name. Ident authentication can only be used on TCP/IP connections. When specified for local connections, peer authentication will be used instead.</para>
          </listitem>
          <listitem>
            <para><literal>peer</literal> - Obtain the client's operating system user name from the operating system and check if it matches the requested database user name. This is only available for local connections.</para>
          </listitem>
        </itemizedlist>
      </listitem>
    </varlistentry>
  </variablelist>
  <para>
    Using a combination of these options, you create a series of rules that govern which hosts can access your database and which hosts are denied. For example, you might change the default HBA rules to only allow remote access to the Red Hat CloudForms Management Engine database (<literal>vmdb_production</literal>) from hosts in a certain subnet. The modified HBA table would looks like this:
  </para>
  <screen>
# TYPE  DATABASE          USER  ADDRESS         METHOD
local   all               all                   peer map=usermap
host    vmdb_production   all   192.168.1.0/24  md5
#hostssl all              all   all             md5
  </screen>
  <para>
    These restrictions help when structuring your Red Hat CloudForms appliances in relationships. For example, use these database restrictions to grant access only between a master database appliance in one region and client appliances from a seperate region.
  </para>
</section>
