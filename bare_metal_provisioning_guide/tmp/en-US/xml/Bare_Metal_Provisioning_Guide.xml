<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Bare_Metal_Provisioning_Guide.ent">
%BOOK_ENTITIES;
]>
<article lang="en-US">
	<xi:include href="Article_Info.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
	 <para>
		Red Hat CloudForms 3.2 provides functionality to provision and monitor bare metal machines through communication with Satellite 6. Satellite 6 is a subscription and system management tool that provides a way to provision hosts (both virtual and bare metal) and configure them using a set of Puppet modules. This guide provides a step-by-step workflow on how to provision bare metal hosts using Red Hat CloudForms 3.2 and Red Hat Satellite 6.
	</para>
	 <section>
		<title>Defining the Workflow</title>
		 <para>
			This guide uses the following workflow:
		</para>
		 <orderedlist>
			<listitem>
				<para>
					Add Red Hat Satellite 6.0 as a Foreman provider to your Red Hat CloudForms Management Engine appliance.
				</para>

			</listitem>
			 <listitem>
				<para>
					Refresh the state of your Red Hat Satellite 6.0 provider in Red Hat CloudForms Management Engine.
				</para>

			</listitem>
			 <listitem>
				<para>
					Provision new bare metal hosts from Red Hat Satellite 6's Discovery service.
				</para>

			</listitem>
			 <listitem>
				<para>
					Reprovision existing bare metal hosts from Red Hat Satellite 6's Discovery service.
				</para>

			</listitem>

		</orderedlist>

	</section>
	 <section>
		<title>Defining the Hostgroup Hierarchy</title>
		 <para>
			Red Hat CloudForms Management Engine displays the Red Hat Satellite 6 infrastructure in a host group and host relationship. A host group defines a set of default values that hosts inherit when placed in that group. Hosts can belong to only one host group, but host groups can be nested in hierarchies. You can create a "base" or "parent" host group that represents all hosts in your organization, and then create nested or "child" host groups under that parent to provide specific settings.
		</para>

	</section>
	 <section>
		<title>Adding a Satellite 6 Provider to CloudForms</title>
		 <para>
			To start provisioning bare metal machines, you need at least one Foreman provider added to Red Hat CloudForms Management Engine. The following procedure show how to do this.
		</para>
		 <procedure>
			<title>Adding a Satellite 6 Provider to CloudForms</title>
			 <step>
				<para>
					Log in to your Red Hat CloudForms Management Engine UI as the administration user.
				</para>

			</step>
			 <step>
				<para>
					Navigate to <menuchoice><guimenu>Infrastructure</guimenu><guisubmenu>Configuration Management</guisubmenu></menuchoice>. The providers list appears and should be empty.
				</para>

			</step>
			 <step>
				<para>
					Select <menuchoice><guimenu>Configuration</guimenu><guisubmenu>Add a new Foreman Provider</guisubmenu></menuchoice>. A empty form for your new Satellite 6 provider appears.
				</para>

			</step>
			 <step>
				<para>
					Enter a <guilabel>Name</guilabel> for the provider. This is just a plain text name to help identify your provider in the Red Hat CloudForms Management Engine UI. For example, <literal>Satellite 6</literal>
				</para>

			</step>
			 <step>
				<para>
					Enter a <guilabel>URL</guilabel> for the provider. This is the root URL for the Satellite 6 server and can be either an IP address or a hostname. For example, <literal>http://satellite6.example.com</literal>
				</para>

			</step>
			 <step>
				<para>
					Select <guilabel>Verify SSL</guilabel> to use encrypted communication with the provider. This requires the SSL certificates from your Foreman provider. <remark>Need to add SSL cert configuration as an Appendix</remark>

				</para>

			</step>
			 <step>
				<para>
					Enter a <guilabel>User ID</guilabel> for a user on the provider. Ideally, this would be a user in Satellite 6 with administrative access.
				</para>

			</step>
			 <step>
				<para>
					Enter a <guilabel>Password</guilabel> and enter it again to <guilabel>Verify Password</guilabel>. Click the <guilabel>Validate</guilabel> button to test your connection with the Satellite 6 server.
				</para>

			</step>
			 <step>
				<para>
					Click <guilabel>Save</guilabel> to confirm your settings and save the provider.
				</para>

			</step>

		</procedure>
		 <para>
			Red Hat CloudForms Management Enginer saves the Satellite 6 provider in its database and triggers a refresh of resources detected in the provider.
		</para>

	</section>
	 <section>
		<title>Triggering a Refresh of a Satellite 6 Provider</title>
		 <para>
			Your Satellite 6 provider can still create new hosts independently of Red Hat CloudForms. Your Red Hat CloudForms appliance detects these changes after an automatic refresh period. However, you can trigger a manual refresh to avoid waiting for the automatic refresh.
		</para>
		 <procedure>
			<title>Triggering a Refresh of a Satellite 6 Provider</title>
			 <step>
				<para>
					Navigate to <menuchoice><guimenu>Infrastructure</guimenu><guisubmenu>Configuration Management</guisubmenu></menuchoice>. The providers list appears.
				</para>

			</step>
			 <step>
				<para>
					Select your Satellite 6 provider using the checkboxes and click <menuchoice><guimenu>Configuration</guimenu><guisubmenu>Refresh Relationships and Power States</guisubmenu></menuchoice>. This triggers the refresh.
				</para>

			</step>
			 <step>
				<para>
					When the refresh complete, click on the Satellite 6 provider to check the updated contents.
				</para>

			</step>

		</procedure>
		 <para>
			The page now displays updated contents of the provider.
		</para>

	</section>
	 <section>
		<title>Enabling the Foreman Discovery Plugin on a Satellite 6 Provider</title>
		 <para>
			The Foreman Discovery plug-in in Red&nbsp;Hat Satellite Server adds Metal-as-a-Service (MaaS) features. Bare-metal hosts on Satellite Server-managed networks can be booted over the network through PXE into stripped-down Red&nbsp;Hat Enterprise&nbsp;Linux systems running from memory to collect and send hardware facts to the Satellite Server.
		</para>
		 <para>
			After they have booted, these systems appear as discovered hosts on the Satellite Server. Administrators can use these collected hardware facts to provision systems, removing the need to manually collect MAC addresses and other hardware information and reducing the time required to provision hosts.
		</para>
		 <para>
			After the provisioning configuration is complete, the Foreman discovery plug-in sends a reboot command to the discovered host and the installation begins. The host then moves from the <guimenu>Discovered Hosts</guimenu> list in the Satellite Server to the <guimenu>All Hosts</guimenu> list.
		</para>
		 <para>
			This section provides a brief set of instructions for configuring Satellite 6 to use to Discovery plugin. For full instructions, see <ulink url="https://access.redhat.com/documentation/en-US/Red_Hat_Satellite/6.0/html/User_Guide/chap-Configuring_the_Foreman_Discovery_Plugin.html#sect-Installing_the_Foreman_Discovery_Plugin">Chapter 11. Using the Foreman Discovery Plugin</ulink> in the <citetitle>Red Hat Satellite 6 User Guide</citetitle>.
		</para>
		 <procedure>
			<title>Enabling the Foreman Discovery Plugin on a Satellite 6 Provider</title>
			 <step>
				<para>
					Run the following command as the <systemitem class="username">root</systemitem> user on the Satellite 6 server to install the Foreman Discovery plug-in:
				</para>
				 
<screen>
[root@satellite6 ~]# yum install foreman-discovery-image
</screen>
				 <para>
					This installs an image containing Foreman Discovery to the TFTP service on you Satellite 6 server.
				</para>

			</step>
			 <step>
				<para>
					Red Hat Satellite 6 contains a Global PXE template that requires modification. In Red Hat Satellite 6.0, this template is locked from editing. To unlock this template, run the <application>rake</application> console on the Satellite 6.0 server.
				</para>
				 
<screen>
[root@satellite6 ~]# foreman-rake console
</screen>
				 <para>
					Enter the following commands in the console:
				</para>
				 
<screen>
&gt; ct = ConfigTemplate.find_by_name("PXELinux global default"); ct.locked = false; ct.save!
&gt; exit
</screen>
				 <para>
					This unlocks the template.
				</para>

			</step>
			 <step>
				<para>
					Log into your Red Hat Satellite 6 UI and navigate to <menuchoice><guimenu>Hosts</guimenu><guimenuitem>Provisioning templates</guimenuitem></menuchoice>. Edit the <literal>PXELinux global default template</literal> and add the following lines:
				</para>
				 
<screen>
LABEL discovery
MENU LABEL Foreman Discovery
MENU DEFAULT
KERNEL boot/foreman-discovery-image-latest.el6.iso-vmlinuz
APPEND rootflags=loop initrd=boot/foreman-discovery-image-latest.el6.iso-img root=live:/foreman.iso rootfstype=auto ro rd.live.image rd.live.check rd.lvm=0 rootflags=ro crashkernel=128M elevator=deadline max_loop=256 rd.luks=0 rd.md=0 rd.dm=0 rd.bootif=0 rd.neednet=0 nomodeset selinux=0 stateless foreman.url=<replaceable>FOREMAN_URL</replaceable>
IPAPPEND 2
</screen>
				 <para>
					This adds an entry for Foreman Discovery when using the default PXE boot service for Satellite 6.
				</para>
				 <para>
					The highlighted <option>FOREMAN_URL</option> option on the APPEND line identifies the location of the Satellite 6 server. Ensure that this is set correctly in global settings or the discovered hosts will not register to Satellite 6.
				</para>
				 <para>
					Also set the <parameter>ONTIMEOUT</parameter> parameter to <literal>discovery</literal> to make the <option>Foreman Discovery</option> option the default:
				</para>
				 
<screen>ONTIMEOUT discovery</screen>
				 <para>
					When completed, save this template.
				</para>

			</step>
			 <step>
				<para>
					Click <guibutton>Build PXE Default</guibutton> to deploy the global default template file to the TFTP server.
				</para>

			</step>

		</procedure>
		 <para>
			This Foreman Discovery plugin is not enabled and configured. The next section tests the service by adding a new bare metal host.
		</para>

	</section>
	 <section>
		<title>Discovering a Bare Metal Host in a Foreman provider</title>
		 <para>
			Before provisioning a bare metal host, Satellite 6 needs to discover them. Satellite 6 achieves this through its Foreman Discovery service, which we configured in the previous section.
		</para>
		 <procedure>
			<step>
				<para>
					Start a new bare metal host and elect to start over the network from the boot options menu. This starts the host using the <acronym>PXE</acronym> service.
				</para>

			</step>
			 <step>
				<para>
					Select <literal>Foreman Discovery</literal> from the <guilabel>PXE boot</guilabel> options menu. The host starts into the <guilabel>Foreman Discovery</guilabel> screen and is automatically registered in the installer.
				</para>

			</step>
			 <step>
				<para>
					Log into the Foreman provider and confirm that the host has been registered:
				</para>
				 <substeps>
					<step>
						<para>
							Click <menuchoice><guimenu>Hosts</guimenu><guimenuitem>Discovered hosts</guimenuitem></menuchoice>.
						</para>

					</step>
					 <step>
						<para>
							Click the name of the newly registered host to open the details page for the host, and review the details.
						</para>

					</step>

				</substeps>

			</step>

		</procedure>
		 <para>
			The host is now included in the list of discovered hosts. Red Hat CloudForms Management Enginer can now provision them.
		</para>

	</section>
	 <section>
		<title>Provisioning a Bare Metal Host in Red Hat CloudForms</title>
		 <para>
		</para>

	</section>
	 <section>
		<title>Reprovisioning a Bare Metal Host in Red Hat CloudForms</title>
		 <para>
		</para>

	</section>
	 <section>
		<title>Tagging a Bare Metal Host in Red Hat CloudForms</title>
		 <para>
		</para>

	</section>
	 <xi:include href="Revision_History.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
	 <index />
</article>

