([[preparing_vm_for_openshift]]

== Preparing a Virtual Machine for OpenShift Enterprise

=== Requirements

To host OpenShift Enterprise, virtual machines require the following:

* Red Hat Enterprise Linux 6.4 or higher

* Network access, with valid IP addresses and access to the OpenShift Enterprise sources, for example, through Red Hat Subscription Manager or Red Hat Satellite

* SSH key access from all appliances running the Automation Role to the virtual machines

* Ruby 1.9.3 or higher

* Red Hat recommends creating a virtual machine template meeting these requirements to enable efficient deployment of multiple instances.
You can use your preferred source, for example PXE, ISO, or Clone, when creating the virtual machine as long as the requirements are met for OpenShift Enterprise installation.

* DNS is an important element of the environment, as machines must be able to connect bi-directionally to any resource in the network using the hostname.
This means that new virtual machines instantiated from the template need to register to your DNS system automatically.

Use the following procedures to prepare a template virtual machine to host OpenShift Enterprise.

=== Creating a Virtual Machine in Red Hat Enterprise Virtualization

Create a new Red Hat Enterprise Linux virtual machine on Red Hat Enterprise Virtualization with the following steps.

[NOTE]
======
For more information on installing virtual machines on Red Hat Enterprise Virtualization, see the https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Virtualization/3.5/html-single/Administration_Guide/index.html#chap-Virtual_Machines[Red Hat Enterprise Virtualization Administration Guide].‚Å†
======

==== Creating a New Virtual Machine

. Click the *Virtual Machines* tab in Red Hat Enterprise Virtualization Manager.
. Click *New VM* to open the *New Virtual Machine* window:
image:7316.png[]
. Enter a *Name* for the virtual machine.
. Select a Linux variant from the *Operating System* drop-down list. OpenShift Enterprise requires Red Hat Enterprise Linux 6.4 or higher.
. Click the *Show Advanced Options* button, and:
.. From the *System* tab, specify the virtual machine's *Memory Size*.
.. From the *Boot Options* tab, choose the *First Device* that the virtual machine will boot from.

* If you have selected *CD-ROM* as a boot device, tick this check box and select a CD-ROM image from the drop-down menu. The images must be available in the ISO domain.
.. You can accept the default settings for all other fields, or change them if required.
. Click *OK*.

The new virtual machine is created and displays in the list of virtual machines in the Red Hat Enterprise Virtualization Manager with a status of `Down`. Before you can use this virtual machine, add at least one network interface and one virtual disk, and install an operating system.


===== Adding a Network Interface to the Virtual Machine

. From the *Virtual Machines* tab, select the virtual machine you created.
. Click the *Network Interfaces* tab in the details pane.
. Click *New*.
. Enter the *Name* of the network interface:
image:7320.png[]
. Use the drop-down lists to select the *Profile* and the *Type* of the network interface. The *Profile* and *Type* drop-down lists are populated in accordance with the profiles and network types available to the cluster, and the network interface cards available to the virtual machine.
. Select the *Custom MAC address* check box and enter a MAC address for the network interface card as required.
. Click *OK*.

The new network interface is listed in the *Network Interfaces* tab in the details pane of the virtual machine. The *Link State* is set to *Up* by default when the network interface card is defined on the virtual machine and connected to the network.

==== Adding a Virtual Disk

Configure storage for your virtual machine by adding a virtual disk. To add a disk to the virtual machine:

. From the *Virtual Machines* tab, select your virtual machine.
. Click the *Disks* tab in the details pane.
. Click *Add* to open the *Add Virtual Disk* window:
image:6578.png[]
. Use the radio buttons choose between *Internal* and the *External (Direct LUN)* disks.
.  Select the *Attach Disk* check box to choose an existing disk from the list and select the *Activate* check box. Alternatively, enter the *Size*, *Alias*, and *Description* for the new disk.
. Use the drop-down lists and check boxes to configure the disk.
. Click *OK*.

The new disk appears in the details pane of the virtual machine after a short time.

==== Installing the Virtual Machine Operating System

Install Red Hat Enterprise Linux 6.4 or higher from an ISO as a basic server on the new virtual machine.

. Click the *Virtual Machines* tab and select a virtual machine with a status of `Down`.
. Click run (image:5033.png[]). Alternatively, right-click the virtual machine and select *Run*. The virtual machine status changes to `Up`, and the operating system installation begins.
. Open a `Remote Viewer` console to the virtual machine if one does not open automatically.
* If `Remote Viewer` is not already installed, install the `virt-viewer` package with the following command, then restart your web browser:
+
------
# yum install virt-viewer
------
+
. Click the *Virtual Machines* tab and select a virtual machine.
. Click console or right-click the virtual machine and select *Console*.

* If the connection protocol is set to SPICE, a console window will automatically open for the virtual machine.
* If the connection protocol is set to VNC, a `console.vv` file will be downloaded. Click on the file and a console window will automatically open for the virtual machine.

. Follow the prompts in the Red Hat Enterprise Linux installer to install the virtual machine's operating system.

For more information on installing Red Hat Enterprise Linux 6, see the: https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/index.html[Red Hat Enterprise Linux Installation Guide].


=== Registering and Configuring the Virtual Machine

Register the virtual machine to the Red Hat Content Delivery Network with the following steps:

. After the installation is complete, reboot the instance and log in as the root user.
. Update the `/etc/sysconfig/network-scripts/ifcfg-eth0` file so it only contains the following values:
+
------
TYPE=Ethernet
DEVICE=eth0
ONBOOT=yes
BOOTPROTO=dhcp
NM_CONTROLLED=no
------
+
. Reboot the machine.
. Register the machine with the Content Delivery Network:
+
------
# subscription-manager register
------
+
..  Enter your Customer Portal user name and password when prompted:
+
------
Username: admin@example.com
Password:
------
+
..  Find entitlement pools containing the channel:
+
------
# subscription-manager list --available | grep -A8 "Red Hat Enterprise Linux Server"
------
+
.. Use the pool identifiers located in the previous step to attach the Red Hat Enterprise Linux Server entitlement to the system:
+
------
# subscription-manager attach --pool=pool_id
------
+
.. Enable the required channel:
+
------
# subscription-manager repos --enable=rhel-6-server-rpms
------
+
. Update the system:
+
------
# yum -y update
------
+
. Install Ruby 1.9.3:
+
------
# yum install ruby
------
+

. Then, unregister the virtual machine so that the resulting image does not contain the same subscription details for every instance cloned based on it.
+
------
# subscription-manager repos --disable=*
# subscription-manager unregister
# yum clean all
------
+

The virtual machine is now registered to the Red Hat Content Delivery Network.


=== Creating a Virtual Machine Template

To create a virtual machine template, you must first generalize (seal) the virtual machine before creating a template based on that virtual machine.

Then you can create a template from the existing virtual machine to use as a blueprint for creating additional virtual machines.

[IMPORTANT]
======
Before you create a template, you must seal the source virtual machine to ensure all system-specific details are removed from the virtual machine. This is necessary to prevent the same details from appearing on multiple virtual machines created based on the same template. For more information, see the: https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Virtualization/3.5/html/Administration_Guide/sect-Sealing_Virtual_Machines_in_Preparation_for_Deployment_as_Templates.html[Red Hat Enterprise Virtualization Administration Guide].
======

==== Sealing a Linux Virtual Machine for Deployment as a Template

. Log in to the virtual machine.
. Flag the system for reconfiguration by running the following command as root:
+
------
# touch /.unconfigured
------
+
. Run the following command to remove SSH host keys:
+
------
# rm -rf /etc/ssh/ssh_host_*
------
+
. Set `HOSTNAME=localhost.localdomain` in `/etc/sysconfig/network`.
. Run the following command to remove `/etc/udev/rules.d/70-*``:
+
------
# rm -rf /etc/udev/rules.d/70-*
------
+
. Remove the `HWADDR` line and `UUID` line from `/etc/sysconfig/network-scripts/ifcfg-eth*`.
. Optionally, delete all the logs from `/var/log` and build logs from `/root`.
. Run the following command to shut down the virtual machine:
+
------
# poweroff
------
+

The virtual machine is sealed and can now be made into a template. You can deploy Linux virtual machines from this template without experiencing configuration file conflicts.


==== Creating a Virtual Machine Template

. Click the *Virtual Machines* tab and select the source virtual machine.
. Ensure the virtual machine is powered down and has a status of `Down`.
. Click *Make Template*.
. Enter a *Name*, *Description*, and *Comment* for the template.
. Select the cluster with which to associate the template from the *Cluster* drop-down list. By default, this is the same as that of the source virtual machine.
. Optionally, select a CPU profile for the template from the *CPU Profile* drop-down list.
. Optionally, select the *Create as a Sub Template* version check box, select a *Root Template*, and enter a *Sub Version Name* to create the new template as a sub template of an existing template.
. In the *Disks Allocation* section, enter an alias for the disk in the *Alias* text field, and select the storage domain on which to store the disk from the *Target* list. By default, these are the same as those of the source virtual machine.
. Select the *Allow all users to access this Template* check box to make the template public.
. Select the *Copy VM permissions* check box to copy the permissions of the source virtual machine to the template.
. Click *OK*.

The virtual machine displays a status of `Image Locked` while the template is being created. The process of creating a template may take up to an hour depending on the size of the virtual machine disk and the capabilities of your storage hardware. When complete, the template is added to the *Templates* tab. You can now create new virtual machines based on the template.


[NOTE]
======
When a template is made, the virtual machine is copied so that both the existing virtual machine and its template are usable after template creation.
======
